;;;
;;; PgBouncer Configuration - Session Mode
;;;
;;; Implements Task P0-32: Hybrid pgBouncer Pool Strategy
;;;
;;; Use Case: Embedding workers (long-running transactions)
;;; Port: 6433
;;;
;;; Architecture:
;;;   Embedding Workers (10 concurrent) → pgBouncer (10 connections) → PostgreSQL (100 max)
;;;

[databases]
; Database connection string
ga4_analytics = host=postgres port=5432 dbname=ga4_analytics user=postgres password=postgres

; Fallback database for pgbouncer stats
pgbouncer = host=postgres port=5432 dbname=pgbouncer user=postgres password=postgres

[pgbouncer]
;;;
;;; Administrative settings
;;;
logfile = /var/log/pgbouncer/pgbouncer-session.log
pidfile = /var/run/pgbouncer/pgbouncer-session.pid
listen_addr = *
listen_port = 5432
unix_socket_dir = /tmp
auth_type = trust
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Pool mode (CRITICAL)
;;;
;;; session: Connection reserved for entire client session
;;;          Required for long transactions (embedding generation: 10-30s)
;;;          PostgreSQL session variables persist across queries
;;;          Temporary tables work correctly
;;;
pool_mode = session

;;;
;;; Connection limits
;;;
max_client_conn = 100        ; Max embedding worker connections
default_pool_size = 10       ; Connections to PostgreSQL per database
reserve_pool_size = 2        ; Extra connections for bursts
max_db_connections = 20      ; Hard limit for this pgBouncer instance

;;;
;;; Connection behavior
;;;
server_lifetime = 7200       ; Close server connections after 2 hours
server_idle_timeout = 1800   ; Close idle server connections after 30 min
server_connect_timeout = 15  ; Timeout for connecting to PostgreSQL
server_login_retry = 15      ; Retry failed connections after 15s

;;;
;;; Client behavior
;;;
client_idle_timeout = 3600   ; Close idle clients after 1 hour
client_login_timeout = 60    ; Timeout for client authentication

;;;
;;; Low-level socket settings
;;;
pkt_buf = 8192              ; Larger packet buffer for batch operations
max_packet_size = 2147483647 ; Max packet size (2GB)
listen_backlog = 64         ; Smaller backlog (fewer concurrent workers)

;;;
;;; Logging
;;;
; log_connections = 1        ; Log all connections (disable in prod)
; log_disconnections = 1     ; Log all disconnections
; log_pooler_errors = 1      ; Log pooler errors
min_pool_size = 2           ; Minimum idle connections to maintain

;;;
;;; DNS settings
;;;
dns_max_ttl = 15            ; DNS cache TTL
dns_nxdomain_ttl = 15       ; Negative DNS cache TTL

;;;
;;; TLS/SSL (if needed)
;;;
; server_tls_sslmode = prefer
; server_tls_ca_file = /etc/ssl/certs/ca.pem
; client_tls_sslmode = prefer
; client_tls_ca_file = /etc/ssl/certs/ca.pem

;;;
;;; Performance tuning for embedding workload
;;;
; For embedding generation with long transactions:
; - session mode: connection held for entire client session
; - Lower max_client_conn: embedding workers are limited (10-20)
; - Lower default_pool_size: fewer concurrent embedding jobs
; - Allows PostgreSQL session variables to persist (SET commands)
; - Supports temporary tables and cursors

